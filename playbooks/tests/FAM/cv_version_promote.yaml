---
- hosts: localhost
  gather_facts: false

  module_defaults:
    group/theforeman.foreman.foreman:
      server_url: "{{ foreman_server_url | default(omit) }}"
      username: "{{ foreman_username | default(omit) }}"
      password: "{{ foreman_password | default(omit) }}"
      validate_certs: "{{ foreman_validate_certs | default(omit) }}"
      organization: "{{ foreman_organization }}"

  tasks:
    - name: ContentViewVersionPromote
      theforeman.foreman.content_view_version:
        content_view: "{{ cv }}"
        version: "{{ version | default(omit) }}"
        lifecycle_environments: "{{ lifecycle_environments | default(omit) }}"
        current_lifecycle_environment: "{{ current_lifecycle_environment | default(omit) }}"
      when:
        - cv is defined and cv | length > 0

    - name: CompositeContentViewVersionPromote
      theforeman.foreman.content_view_version:
        content_view: "{{ content_view.name | default(content_view.content_view) | default(content_view) }}"
        version: "{{ content_view.version | default(omit) }}"
        lifecycle_environments: "{{ lifecycle_environments | default(omit) }}"
        current_lifecycle_environment: "{{ current_lifecycle_environment | default(omit) }}"
      # XXX: We want to promote only CCVs, not CVs
      loop: "{{ content_views | from_json | selectattr('components', 'defined') | list }}"
      loop_control:
        loop_var: content_view
      when:
        - content_views is defined and content_views | length > 0
...
