---
- hosts: localhost
  gather_facts: false

  module_defaults:
    group/theforeman.foreman.foreman:
      server_url: "{{ foreman_server_url | default(omit) }}"
      username: "{{ foreman_username | default(omit) }}"
      password: "{{ foreman_password | default(omit) }}"
      validate_certs: "{{ foreman_validate_certs | default(omit) }}"
      # organization: "{{ foreman_organization }}"

  tasks:
    - name: JobInvocationCreate
      theforeman.foreman.job_invocation:
        job_template: "{{ job_template | default(omit) }}"
        search_query: "{{ search_query | default(omit) }}"
        command: "{{ command | default(omit) }}"
        description_format: "{{ description_format | default(omit) }}"
        inputs: "{{ inputs | default(omit) }}"
        feature: "{{ feature | default(omit) }}"
      register: __job_invocation
      ignore_errors: true

    - name: Get task ID
      ansible.builtin.set_fact:
        task_id: "{{ __job_invocation.entity.job_invocations[0].task.id }}"

    - name: Wait for forked task to finish
      theforeman.foreman.wait_for_task:
        task: "{{ task_id }}"
        timeout: "{{ task_timeout | default(omit) }}"
      register: __wait_for_task
      until: >-
        __wait_for_task is succeeded or
        ('Remote end closed connection without response' not in (__wait_for_task.msg | default('')) or
         'A sub task failed' in (__wait_for_task.msg | default('')))
      retries: "{{ num_retries | default(5) }}"
      delay: "{{ retry_delay | default(30) }}"
      ignore_errors: true

    - name: GetForemanTaskResourceInfo
      theforeman.foreman.resource_info:
        resource: foreman_tasks
        search: "id = {{ task_id }}"
      failed_when:
        - __wait_for_task is failed
...
